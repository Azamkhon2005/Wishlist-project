name: Security - IaC & Container (P12)

on:
  workflow_dispatch:
  push:
    paths:
      - "Dockerfile"
      - "iac/**"
      - "security/**"
      - ".github/workflows/ci-p12-iac-container.yml"

permissions:
  contents: read
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  iac_container_security:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure evidence dirs
        run: mkdir -p EVIDENCE/P12

      # 1. Build Image (—á—Ç–æ–±—ã –±—ã–ª–æ —á—Ç–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å Trivy)
      - name: Build Docker Image
        run: |
          docker build -t wishlist:local .

      # 2. Hadolint (Dockerfile Linter)
      - name: Run Hadolint
        run: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º docker run –¥–ª—è –∑–∞–ø—É—Å–∫–∞ hadolint
          docker run --rm -i -v $PWD/security/hadolint.yaml:/root/.hadolint.yaml \
            hadolint/hadolint < Dockerfile > EVIDENCE/P12/hadolint_report.json || true

          # –î–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –≤ –ª–æ–≥–∞—Ö –≤—ã–≤–µ–¥–µ–º, –µ—Å–ª–∏ json –Ω–µ –ø—É—Å—Ç
          cat EVIDENCE/P12/hadolint_report.json

      # 3. Checkov (IaC Scanner)
      - name: Run Checkov
        run: |
          # –°–∫–∞–Ω–∏—Ä—É–µ–º Dockerfile –∏ –ø–∞–ø–∫—É iac/
          docker run --rm --volume $PWD:/work --workdir /work \
            bridgecrew/checkov \
            --config-file /work/security/checkov.yaml \
            --directory /work/iac \
            --file /work/Dockerfile \
            > EVIDENCE/P12/checkov_report.json || true

      # 4. Trivy (Container Image Scanner)
      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'wishlist:local'
          format: 'json'
          output: 'EVIDENCE/P12/trivy_report.json'
          severity: 'CRITICAL,HIGH'
          trivy-config: 'security/trivy.yaml'

      # 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–≤–æ–¥–∫–∏ (Hardening Summary)
      - name: Generate Hardening Summary
        run: |
          echo "# P12 - IaC & Container Security Summary" > EVIDENCE/P12/hardening_summary.md

          echo "## üê≥ Dockerfile (Hadolint)" >> EVIDENCE/P12/hardening_summary.md
          HADO_COUNT=$(jq '. | length' EVIDENCE/P12/hadolint_report.json)
          echo "- Issues found: $HADO_COUNT" >> EVIDENCE/P12/hardening_summary.md

          echo "" >> EVIDENCE/P12/hardening_summary.md
          echo "## üèóÔ∏è IaC (Checkov)" >> EVIDENCE/P12/hardening_summary.md
          # –ü–∞—Ä—Å–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã Checkov (failed checks)
          CHECKOV_FAIL=$(jq '.results.failed_checks | length' EVIDENCE/P12/checkov_report.json || echo "0")
          echo "- Failed checks: $CHECKOV_FAIL" >> EVIDENCE/P12/hardening_summary.md

          echo "" >> EVIDENCE/P12/hardening_summary.md
          echo "## üõ°Ô∏è Image Vulnerabilities (Trivy)" >> EVIDENCE/P12/hardening_summary.md
          TRIVY_HIGH=$(jq '.Results[].Vulnerabilities | map(select(.Severity=="HIGH")) | length' EVIDENCE/P12/trivy_report.json || echo "0")
          TRIVY_CRIT=$(jq '.Results[].Vulnerabilities | map(select(.Severity=="CRITICAL")) | length' EVIDENCE/P12/trivy_report.json || echo "0")
          echo "- HIGH: $TRIVY_HIGH" >> EVIDENCE/P12/hardening_summary.md
          echo "- CRITICAL: $TRIVY_CRIT" >> EVIDENCE/P12/hardening_summary.md

          echo "" >> EVIDENCE/P12/hardening_summary.md
          echo "Full reports available in artifacts." >> EVIDENCE/P12/hardening_summary.md

      - name: Upload Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: P12_EVIDENCE
          path: EVIDENCE/P12
